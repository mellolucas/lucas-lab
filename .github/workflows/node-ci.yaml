name: Node CI
run-name: >-
  ${{ github.workflow }}
  ${{ contains(inputs.dry-run, 'true') && ' ðŸ§ª' || '' }}
  ${{ contains(github.event.pull_request.draft, 'true') && ' ðŸ“' || '' }}

on:
  pull_request:
    branches: main
  workflow_dispatch:
    inputs:
      # Static Code Analysis Options
      require-lockfile:
        description: |
          Fail if lockfile is missing or out-of-date. Disable to allow
          generating or updating an ephemeral lockfile on-the-fly.
        required: false
        type: boolean
        default: true
      check-spell:
        description: |
          Run `spell:check`, `check:spell`, `cspell` or `spell` package script
          to check for spelling issues.
        required: false
        type: boolean
        default: false
      check-format:
        description: |
          Run `format:check`, `check:format` or `format` package script to
          check code formatting.
        required: false
        type: boolean
        default: true
      check-lint:
        description: |
          Run `lint:check`, `check:lint` or `lint` package script to
          check for linting issues.
        required: false
        type: boolean
        default: true
      check-types:
        description: |
          Run `types:check`, `check:types` or `types` package script to
          check for type errors.
        required: false
        type: boolean
        default: true

      # Workflow Control Options
      dry-run:
        description: |
          Enable dry-run mode. This will skip steps that make changes.
        required: false
        type: boolean
        default: false

concurrency:
  group: >-
    ${{
      format('ci-{0}-{1}-{2}',
        github.workflow,
        github.event.name || 'null',
        github.event.number || github.ref
      )
    }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  call-analysis:
    name: Call analysis
    uses: lufomatics/reusables/.github/workflows/node-analysis.yaml@v1
    secrets:
      registry-token: ${{ secrets.NPM_TOKEN }}

    with:
      # Tips for handling boolean inputs that may not exist depending on event:
      # - "!contains(inputs.dry-run, 'false')" to use input or fallback to true;
      # - "contains(inputs.dry-run, 'true')" to use input or fallback to false.
      runs-on: ${{ vars.DEFAULT_RUNNER || 'ubuntu-latest' }}
      dry-run: ${{ contains(inputs.dry-run, 'true') }}
      require-lockfile: ${{ !contains(inputs.require-lockfile, 'false') }}
      check-spell: ${{ !contains(inputs.check-spell, 'false') }}
      check-format: ${{ !contains(inputs.check-format, 'false') }}
      check-lint: ${{ !contains(inputs.check-lint, 'false') }}
      check-types: ${{ !contains(inputs.check-types, 'false') }}
      node-version-file: "package.json"

  call-build:
    name: Call build
    needs: call-analysis
    uses: .github/workflows/node-build.yaml
    secrets:
      registry-token: ${{ secrets.NPM_TOKEN }}
