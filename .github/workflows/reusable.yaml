name: Reusable Test
run-name: >-
  ${{ github.workflow }}
  ${{ contains(inputs.break, 'true') && ' ðŸ’¥' || ''}}
  ${{ contains(inputs.continue-on-error, 'true') && ' ðŸš§' || ''}}
  ${{ format('(string:{0}; boolean:{1}; runs-on:{2})', 
    inputs.string-input, 
    inputs.boolean-input, 
    inputs.runs-on
  ) }}

on:
  workflow_call:
    inputs:
      runs-on:
        description: "runs-on argument"
        required: false
        type: string
      string-input:
        description: "My string input"
        required: false
        type: string
      boolean-input:
        description: "My boolean input"
        required: false
        type: boolean
      break:
        description: "Break the workflow"
        required: false
        type: boolean
        default: false
      continue-on-error:
        description: "Continue on error"
        required: false
        type: boolean
        default: false

    outputs:
      jobs-context:
        description: "The jobs context serialized to JSON"
        value: ${{ toJSON(jobs) }}
      outcome: 
        description: The overall outcome of the reuseable workflow.
        value: >-
          ${{
            contains(jobs.*.outputs.outcome, 'failure') && 
              'failure' ||
              contains(jobs.*.result, 'failure') && 
                'failure' ||
              contains(jobs.*.result, 'cancelled') && 
                'cancelled' ||
              !contains(jobs.*.result, 'success') && 
                'skipped' ||
              contains(jobs.*.result, 'success') && 
                'success' ||
              'null'
          }}

env:
  STRING_INPUT: ${{ inputs.string-input }}
  BOOLEAN_INPUT: ${{ inputs.boolean-input }}
  RUNS_ON: ${{ inputs.runs-on }}

jobs:
  test-reusable:
    runs-on: >-
      ${{
        ( contains(inputs.runs-on, '"') || contains(inputs.runs-on, '''') ) &&
        fromJSON(inputs.runs-on) ||
        inputs.runs-on
      }}
    if: ${{ inputs.string-input != 'skipjob' && !contains(github.event.pull_reuest.title, 'skipjob') }}
    outputs:
      steps-context: ${{ toJSON(steps) }}
      job-context: ${{ toJSON(job) || 'null' }}
      job-status: ${{ job.status || 'null' }}
      outcome: >-
        ${{ 
          contains(steps.*.outcome, 'failure') && 
            'failure' ||
            job.status || 
            'null' 
        }}
    steps:
      - name: Print context
        id: context
        env:
          GH_CONTEXT: ${{ toJSON(github) }}
          GH_INPUTS: ${{ toJSON(inputs) }}
          GH_RUNNER: ${{ toJSON(runner) }}
          GH_EVENT: ${{ toJSON(github.event) }}
        run: |
          echo "::group::Inputs with different access methods:"
          echo "inputs.string-input: ${{ inputs.string-input }}"
          echo "inputs['string-input']: ${{ inputs['string-input'] }}"
          echo "github.event.inputs.string-input: ${{ github.event.inputs.string-input }}"
          echo "toJSON(inputs.string-input): ${{ toJSON(inputs.string-input) }}"
          echo "toJSON(inputs['string-input']): ${{ toJSON(inputs['string-input']) }}"
          echo "toJSON(github.event.inputs.string-input): ${{ toJSON(github.event.inputs.string-input) }}"
          echo "env.STRING_INPUT: ${{ env.STRING_INPUT }}"
          echo "\${STRING_INPUT}: ${STRING_INPUT}"
          echo
          echo "inputs.boolean-input: ${{ inputs.boolean-input }}"
          echo "inputs['boolean-input']: ${{ inputs['boolean-input'] }}"
          echo "github.event.inputs.boolean-input: ${{ github.event.inputs.boolean-input }}"
          echo "toJSON(inputs['boolean-input']): ${{ toJSON(inputs.boolean-input) }}"
          echo "toJSON(inputs['boolean-input']): ${{ toJSON(inputs['boolean-input']) }}"
          echo "toJSON(github.event.inputs.boolean-input): ${{ toJSON(github.event.inputs.boolean-input) }}"
          echo "env.BOOLEAN_INPUT: ${{ env.BOOLEAN_INPUT }}"
          echo "\${BOOLEAN_INPUT}: ${BOOLEAN_INPUT}"
          echo "::endgroup::"
          echo 
          echo "::group::boolean-input comparisons:"
          echo "inputs.boolean-input == true: ${{ inputs.boolean-input == true && 'true' || 'false' }}"
          echo "inputs.boolean-input == false: ${{ inputs.boolean-input == false && 'true' || 'false' }}"
          echo "inputs.boolean-input == 'true': ${{ inputs.boolean-input == true && 'true' || 'false' }}"
          echo "inputs.boolean-input == 'false': ${{ inputs.boolean-input == false && 'true' || 'false' }}"
          echo "inputs.boolean-input == 1: ${{ inputs.boolean-input == 1 && 'true' || 'false' }}"
          echo "inputs.boolean-input == 0: ${{ inputs.boolean-input == 0 && 'true' || 'false' }}"
          echo "inputs.boolean-input == '1': ${{ inputs.boolean-input == 1 && 'true' || 'false' }}"
          echo "inputs.boolean-input == '0': ${{ inputs.boolean-input == 0 && 'true' || 'false' }}"
          echo "contains(inputs.boolean-input, 'true'): ${{ contains(inputs.boolean-input, 'true') && 'true' || 'false' }}" # Best so far when need to default to false (wants true only when explicit)
          echo "!contains(inputs.boolean-input, 'true'): ${{ !contains(inputs.boolean-input, 'true') && 'true' || 'false' }}" # Only returns false when the arg is explicitly true. Just like "contains(inputs.boolean-input, 'true')", but inverts the result (returns true when that would return false).
          echo "contains(inputs.boolean-input, 'false'): ${{ contains(inputs.boolean-input, 'false') && 'true' || 'false' }}" # Only returns true when the arg is explicitly false. Just like "!contains(inputs.boolean-input, 'false')", but inverts the result (returns true when that would return false).
          echo "!contains(inputs.boolean-input, 'false'): ${{ !contains(inputs.boolean-input, 'false') && 'true' || 'false' }}" # Best so far when need to default to true (wants false only when explicit)
          echo "::endgroup::"
          echo
          echo "::group::null-input comparisons:"
          echo "inputs.null-input == true: ${{ inputs.null-input == true && 'true' || 'false' }}"
          echo "inputs.null-input == false: ${{ inputs.null-input == false && 'true' || 'false' }}"
          echo "inputs.null-input == 'true': ${{ inputs.null-input == true && 'true' || 'false' }}"
          echo "inputs.null-input == 'false': ${{ inputs.null-input == false && 'true' || 'false' }}"
          echo "inputs.null-input == 1: ${{ inputs.null-input == 1 && 'true' || 'false' }}"
          echo "inputs.null-input == 0: ${{ inputs.null-input == 0 && 'true' || 'false' }}"
          echo "inputs.null-input == '1': ${{ inputs.null-input == 1 && 'true' || 'false' }}"
          echo "inputs.null-input == '0': ${{ inputs.null-input == 0 && 'true' || 'false' }}"
          echo "contains(inputs.null-input, 'true'): ${{ contains(inputs.null-input, 'true') && 'true' || 'false' }}"
          echo "!contains(inputs.null-input, 'true'): ${{ !contains(inputs.null-input, 'true') && 'true' || 'false' }}"
          echo "contains(inputs.null-input, 'false'): ${{ contains(inputs.null-input, 'false') && 'true' || 'false' }}"
          echo "!contains(inputs.null-input, 'false'): ${{ !contains(inputs.null-input, 'false') && 'true' || 'false' }}"
          echo "::endgroup::"
          echo
          echo "::group::github context comparisons:"
          echo "Testing 'github.event.repository.has_issues', that is explicitly true" 
          echo "contains(github.event.repository.has_issues, 'true'): ${{ contains(github.event.repository.has_issues, 'true') && 'true' || 'false' }}"
          echo "!contains(github.event.repository.has_issues, 'true'): ${{ !contains(github.event.repository.has_issues, 'true') && 'true' || 'false' }}"
          echo "contains(github.event.repository.has_issues, 'false'): ${{ contains(github.event.repository.has_issues, 'false') && 'true' || 'false' }}"
          echo "!contains(github.event.repository.has_issues, 'false'): ${{ !contains(github.event.repository.has_issues, 'false') && 'true' || 'false' }}"
          echo
          echo "Testing 'github.event.repository.archived', that is explicitly false" 
          echo "contains(github.event.repository.archived, 'true'): ${{ contains(github.event.repository.archived, 'true') && 'true' || 'false' }}"
          echo "!contains(github.event.repository.archived, 'true'): ${{ !contains(github.event.repository.archived, 'true') && 'true' || 'false' }}"
          echo "contains(github.event.repository.archived, 'false'): ${{ contains(github.event.repository.archived, 'false') && 'true' || 'false' }}"
          echo "!contains(github.event.repository.archived, 'false'): ${{ !contains(github.event.repository.archived, 'false') && 'true' || 'false' }}"
          echo
          echo "Testing 'github.event.release.draft', that should not exist for this workflow" 
          echo "contains(github.event.release.draft, 'true'): ${{ contains(github.event.release.draft, 'true') && 'true' || 'false' }}"
          echo "!contains(github.event.release.draft, 'true'): ${{ !contains(github.event.release.draft, 'true') && 'true' || 'false' }}"
          echo "contains(github.event.release.draft, 'false'): ${{ contains(github.event.release.draft, 'false') && 'true' || 'false' }}"
          echo "!contains(github.event.release.draft, 'false'): ${{ !contains(github.event.release.draft, 'false') && 'true' || 'false' }}"
          echo "::endgroup::"
          echo
          echo "---"
          echo
          echo "::group::Inputs toJSON (raw block deserialized):"
          jq . <<< "${GH_INPUTS}"
          echo "::endgroup::"
          echo
          echo "---"
          echo
          echo "::group::GitHub context toJSON:"
          jq . <<< "${GH_CONTEXT}"
          echo "::endgroup::"
          echo
          echo "---"
          echo
          echo "::group::GitHub event toJSON:"
          jq . <<< "${GH_EVENT}"
          echo "::endgroup::"
          echo
          echo "---"
          echo
          echo "::group::Runner context toJSON:"
          jq . <<< "${GH_RUNNER}"
          echo "::endgroup::"
          echo
          echo "---"
          echo
          echo "::group::Steps context:"
          echo "${{ toJSON(steps) }}"
          echo "::endgroup::"
          echo

      - name: Skippable
        id: skippable
        if: ${{ inputs.string-input != 'skip' && !contains(github.event.pull_reuest.title, 'skip') }}
        run: echo "This step was not skipped."

      - name: Sleep
        id: sleep
        run: sleep 5

      - name: Run test
        id: test
        continue-on-error: ${{ contains(inputs.continue-on-error, 'true') }}
        run: |
          echo test
          echo "---      ---      ---"
          ${{ contains(inputs.break, 'true') && true || false }} && exit 1 || true
          echo

